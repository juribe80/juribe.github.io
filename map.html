<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Waypoints in Directions</title>
    <style>
      #right-panel {
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }

      #right-panel select, #right-panel input {
        font-size: 15px;
      }

      #right-panel select {
        width: 100%;
      }

      #right-panel i {
        font-size: 12px;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
        float: left;
        width: 70%;
        height: 100%;
      }
      #right-panel {
        margin: 20px;
        border-width: 2px;
        width: 20%;
        height: 400px;
        float: left;
        text-align: left;
        padding-top: 0;
      }
      #directions-panel {
        margin-top: 10px;
        background-color: #FFEE77;
        padding: 10px;
        overflow: scroll;
        height: 174px;
      }
    </style>
    <script src="jquery-3.3.1.min.js"></script>

    <script>
        var currentMarkers = [];
        var nameLocations = [];
        var infoWindow;
        var map;

        //initializes map
        function initMap() {
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer;

            map = new google.maps.Map(document.getElementById('map'), {
              zoom: 5,
              center: {lat: 36.0768222, lng: -80.9551165}
            });
            directionsDisplay.setMap(map);

            document.getElementById('submit').addEventListener('click', function() {
              calculateAndDisplayRoute(directionsService, directionsDisplay);
            });
        }

        //updates markers on map after button click
        function updateMap(minRating) {
            if (nameLocations.length == 0){
              console.log('nameLocations has zero index...exiting loop');
              return;
            }

            //removes last index of nameLocations and saves it into location variable
            var location = nameLocations.splice(-1,1);
            var cord1;
            var cord2;
            var i;
            //search within coordinate 'database' for coordinates
            for(i = 0; i < coordinates.length; i++){
                console.log(i.toString() + '. Comparing ' + coordinates[i][0] + ' and ' + location);
                if(coordinates[i][0] == location){
                    cord1 = coordinates[i][1];
                    cord2 = coordinates[i][2];
                    console.log('Equivalent found! cord1 = ' + cord1.toString() + ' cord2 = ' + cord2.toString());
                    break;
                }
            }

            //var center = new google.maps.LatLng(41.85, -87.65);
            var center = new google.maps.LatLng(cord1, cord2);
            var request = {
                location: center,
                radius: 3219,                           //radius is in meters, 8047 m = 5 miles
                types: ['restaurant']
            };

            infoWindow = new google.maps.InfoWindow(); 

            var service = new google.maps.places.PlacesService(map);

            clearMarkers();

            //updates and places new markers based on condition
            service.nearbySearch(request, function(results, status){
                if (status == google.maps.places.PlacesServiceStatus.OK)
                    for(var i = 0; i < results.length; i++)
                        if (results[i].rating >= minRating)
                            createMarker(results[i]);
            });

            //run function again
            updateMap(minRating);
        }

        //resets and removes all current markers
        function clearMarkers(){
            for(var i = 0; i < currentMarkers.length; i++)
                currentMarkers[i].setMap(null);
            currentMarkers = [];
        }

        //creates marker for each location
        function createMarker(place){
            var placeLoc = place.geometry.location;
            var marker = new google.maps.Marker({
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP,
                position: place.geometry.location
            });

            currentMarkers.push(marker);        //adds google.maps.Marker object into array

            //listens for whenever marker is clicked, display infoWindow
            google.maps.event.addListener(marker, 'click', function(){
                var imgPath = place.photos[0].getUrl({maxWidth: 200, maxHeight: 200});
                var string = '<div> <img src=' + imgPath + '> </div>' + '<h2>' + place.name + '</h2><h4>Rating: ' + place.rating + '</h4>' + '\n<h5>Address: ' + place.formatted_address + '</h5> <h6>\nPrice Level: ' + place.price_level + '</h6>'
                infoWindow.setContent(string);      //content set for each info window
                infoWindow.open(map, this);

                //closes infoWindow after clicking outside of it
                google.maps.event.addListener(map, 'click', function(){
                    infoWindow.close(map, this);
                })
            })
        }

        //list of major cities and their coordinates, used for get_hot_spots()
        var coordinates = [
            ['Princeton, NJ, USA',40.3454139,-74.7247762],
            ['New York, NY, USA',40.7013427,-74.014831],
            ['Miami, FL, USA',25.7844002,-80.2888567],
            ['Washington, DC, USA',38.8943144,-77.1354377],
            ['San Francisco, CA, USA',37.757815,-122.4891015],
            ['Chicago, IL, USA',41.8339042,-87.9750827],
            ['Jacksonville, FL, USA',30.3485355,-81.9991178],
            ['Atlanta, GA, USA',33.7679192,-84.5462729],
            ['Myrtle Beach, SC, USA',33.7184407,-78.9309958],
        ];

        //autofill function used for input boxes
        function activateAutoFill(){
            var input = '';
            if (document.getElementById('start').value.length != 0){
              input = document.getElementById('start');
            }
            else if (document.getElementById('end').value.length != 0){
              input = document.getElementById('end');
            }
            else if (document.getElementById('wayPointText').value.length != 0){
              input = document.getElementById('wayPointText');
            }
            
            var autocomplete = new google.maps.places.Autocomplete(input);
        }

    </script>
    <link rel="stylesheet" type="text/css" href="index.css">
     <link rel="stylesheet" href="https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css"/>
   <link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css">
    <script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>
</head>
  <body>
      <header class="bg-white w-100 ph3 pv3 pv4-ns ph4-m ph5-l">
      <nav class="f4 fw6 ttu tracked">
        <a class="link dim dark-green dib mr3" href="index.html" title="Home">mojamapa</a>
        <a class="link dim black dib mr3" href="index.html#writtenContent" title="About">About</a>
        <a class="link dim black dib" href="index.html#contactInfo" title="Contact">Contact</a>
      </nav>
    </header>
    <div id="map"></div>
    <div id="right-panel">
    <div>

    <script>
        function refreshMarkers(){
            if(document.getElementById('4star').checked)
                updateMap(4);
            else if(document.getElementById('3star').checked)
                updateMap(3);
            else
                document.write("No valid checkbox selected.");
        }
    </script>

    <b>Start:</b>
    <br>
    <input type="text" id="start" name="search_term" value="" oninput="activateAutoFill()">

    <br> <b>Waypoints:</b> <br>
    <input type="text" id="wayPointText" name="search_term" value="" oninput="activateAutoFill()"> 
    <button  id="next" onclick="addWayPoint()">Add</button>
    
    <ul id="wayPoints">
      <!--<li id="wayPoint" class="wayPoint">Myrtle Beach, SC <button id="wayPointButton" onclick="removeWayPoint()">Remove</button></li>
      <li id="wayPoint" class="wayPoint">Atlanta, GA  <button id="wayPointButton" onclick="removeWayPoint()">Remove</button></li>
    -->
    </ul>

    <b>End:</b>
    <br>
    <input type="text" id="end" name="search_term" value="" oninput="activateAutoFill()">

    <br>
      <input type="submit" id="submit">
      
    </div>

    <form>
      <fieldset>
       <legend>Selecting Minimum Rating:</legend>
       <p>
          <!-- name = "radSize" is kept in order to only enable 1 radio button active at a time-->
          <label>Ratings: </label>            
          <input type = "radio"
                 name = "radSize"     
                 id = "4star" />
          <label>4 Star</label>
          <input type = "radio"
                 name = "radSize"
                 id = "3star" />
          <label>3 Star</label>
        </p>       
      </fieldset>     
    </form>

    <button type="button" onclick=refreshMarkers()>Refresh</button>

    <div id="directions-panel"></div>
    </div>
    <script>

      function addWayPoint(){
        console.log(document.getElementById('wayPointText').value);
        var li ="<li id=\"wayPoint\" class=\"wayPoint\">" + document.getElementById('wayPointText').value + " <button id=\"wayPointButton\" onclick=\"removeWayPoint()\">Remove</button></li>";
        document.getElementById("wayPoints").insertAdjacentHTML('beforeend', li);
        document.getElementById('wayPointText').value = "";
      }

      function removeWayPoint(){
        var elem = document.getElementById('wayPoint');
        var elem2 = document.getElementById('wayPointButton');
        elem.parentNode.removeChild(elem);
        elem2.parentNode.removeChild(elem2);
      }

      function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        var waypts = [];
        //var nameLocations = [];

        //inserts each waypoint into the array
        $(".wayPoint").each(function(){
          var str = $(this).text();
          str = str.slice(0,-7);
          waypts.push({
            location: str,
            stopover: true
          });
          nameLocations.push(str);
        });

        nameLocations.push(document.getElementById('start').value);       //insert start and end state
        nameLocations.push(document.getElementById('end').value);

        console.log('nameLocations.length = ' + nameLocations.length.toString());
        console.log('nameLocations = ' + nameLocations.toString());

        //copies waypoints into global array
        //points_of_interests = waypts.slice(0);

        directionsService.route({
          origin: document.getElementById('start').value,
          destination: document.getElementById('end').value,
          waypoints: waypts,
          optimizeWaypoints: true,
          travelMode: 'DRIVING'
        }, function(response, status) {
          if (status === 'OK') {
            directionsDisplay.setDirections(response);

            var route = response.routes[0];
            var summaryPanel = document.getElementById('directions-panel');

            summaryPanel.innerHTML = '';
            // For each route, display summary information.
            for (var i = 0; i < route.legs.length; i++) {
              var routeSegment = i + 1;
              summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment +
                  '</b><br>';
              summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
              summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
              summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
            }
            console.log('End of route reached...');
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });

      }

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDdCAy7ootbjVOT9tQYPFI20kbNhWKDeG0&libraries=places&callback=initMap">
    </script>
  </body>
</html>